{% extends "compare/layout.html" %}
{% block title %}
Plot
{% endblock %}

{% block content %}

{% if alert_message %}
    <script>alert("{{ alert_message }}");</script>

    <br><br>

    <div id="go-back-container">
        <a id="go-back" href="{% url 'visu' %}">Go back</a>
    </div>
{% else %}
  
<div id="plot-container">
    
    {% if html_graphs %}
        {{ html_graphs|safe }}
    {% endif %}

    <div class="checkboxesContainer">
        <div id="sigmaContainer">
            <h3>Sigmas</h3>
            {% for contour in extracted_contours %}
                <input class="color-checkbox" type="checkbox" value="{{ contour }}" checked>{{ forloop.revcounter }}Ïƒ<br>
            {% endfor %}
        </div>

        <br><br>

        <div id="filesContainer">
            <h3>Files</h3>
            {% for filename in filenames %}
                <label class="label-checkbox">
                    <input class="file-checkbox" type="checkbox" value="{{ filename }}" checked>{{ filename }}<br>
                </label>
            {% endfor %}
        </div>
    </div>

</div>
<br><br>

<div id="go-back-container">
    <a id="go-back" href="{% url 'visu' %}">Go back</a>
</div>

<script>
    window.onload = function() {
        // Function to apply color to file name text
        function applyColorToFileNames() {
            // Retrieve all <g> groups from the graph
            var groups = $('#plot-container').find('g.mpld3-paths > g');

            // Browse all groups
            groups.each(function(gIndex, element) {
                var paths = $(element).find('path.mpld3-path');
                
                paths.each(function() {
                    var style = $(this).attr('style');
                    var colorRegex = /stroke:#([0-9A-Fa-f]{6})/;
                    var match = style.match(colorRegex);
                    if (match) {
                        var correctMatch = "#" + match[1];
                        var fileNameIndex = gIndex; // Group index corresponds to file
                        $('.label-checkbox').eq(fileNameIndex).css('color', correctMatch);
                    }
                });
            });
        }

        // Call the function to apply colors when the page is fully loaded
        applyColorToFileNames();
    };

    // Event manager for checkboxes
    $('.color-checkbox').each(function(index) {
        // Assign current index to checkbox value
        $(this).val(index);
        
    }).change(function() {
        // Retrieve checkbox index
        var index = parseInt($(this).val());

        // Retrieve all <g> groups from the graph
        var groups = $('#plot-container').find('g.mpld3-paths > g');

        // Check if the checkbox is checked
        var isChecked = $(this).is(':checked');
        console.log(isChecked);

        // Browse all groups
        groups.each(function() {
            // Retrieve paths within this group
            var paths = $(this).find('path.mpld3-path');

            // List the path indexes in this group
            paths.each(function() {

                var pathIndex = $(this).index();

                if(pathIndex === index) {
                    var style = $(this).attr('style');
                    var colorRegex = /stroke:#([0-9A-Fa-f]{6})/;

                    var match = style.match(colorRegex);
                    var correctMatch = "#" + match[1];

                    if (!isChecked) {
                        // Comment the corresponding part in the path style
                        style = style.replace(colorRegex, '/* stroke:' + correctMatch + ' */');
                        
                        // Apply modified style to path
                        $(this).attr('style', style);
                    } else {
                        // Remove the comment from the corresponding part in the path style
                        style = style.replace('/* stroke:' + correctMatch + ' */', 'stroke:' + correctMatch);
                        
                        // Apply modified style to path
                        $(this).attr('style', style);
                    }
                }

            });
        });
    });

    $('.file-checkbox').each(function(index) {
        // Assign current index to checkbox value
        $(this).val(index);
        
    }).change(function() {
        // Retrieve checkbox index
        var index = parseInt($(this).val());

        // Retrieve all <g> groups from the graph
        var groups = $('#plot-container').find('g.mpld3-paths > g');

        // Check if the checkbox is checked
        var isChecked = $(this).is(':checked');

        // Browse all groups
        groups.each(function(gIndex, element) {

            if(gIndex === index) {
                
                var paths = $(element).find('path.mpld3-path');
                
                paths.each(function() {

                    var style = $(this).attr('style');
                    var colorRegex = /stroke:#([0-9A-Fa-f]{6})/;

                    var match = style.match(colorRegex);
                    var correctMatch = "#" + match[1];

                    if (!isChecked) {
                        // Comment the corresponding part in the path style
                        style = style.replace(colorRegex, '/* stroke:' + correctMatch + ' */');
                        
                        // Apply modified style to path
                        $(this).attr('style', style);
                    } else {
                        // Remove the comment from the corresponding part in the path style
                        style = style.replace('/* stroke:' + correctMatch + ' */', 'stroke:' + correctMatch);
                        
                        // Apply modified style to path
                        $(this).attr('style', style);
                    }
                })
            }
        });
    });

</script>

{% endif %}

{% endblock %}